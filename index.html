<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ•¸å­—è¯å®¹é“</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
  }
  .container {
    display: inline-block;
    margin-top: 5px;
    transform-origin: top center;
  }
  table {
    border-collapse: collapse;
    margin: 20px auto;
  }
  td {
    width: 60px; height: 60px;
    border: 1px solid #333;
    text-align: center;
    vertical-align: middle;
    font-size: 20px;
  }
  .empty {
    background-color: #eee;
  }
  .hidden {
    display: none;
  }
  .button-group {
    margin: 15px 0;
  }
  .button-group button {
    font-size: 20px;
    padding: 10px 20px;
    margin: 0 10px;
  }
  .reset-btn {
    margin-top: 20px;
  }
  .id-display {
    margin-top: 10px;
    font-weight: bold;
  }
  #size-menu {
    margin-top: 10px;
  }
</style>
</head>
<body>

<div id="game-page">
  <div class="container" id="container">
    <h2>æ•¸å­—è¯å®¹é“</h2>
    <button onclick="showGoal()">éŠæˆ²ç›®æ¨™</button>
    <button onclick="toggleBoardSizeMenu()">æ£‹ç›¤å¤§å°</button>
    <div id="size-menu" class="hidden">
      <button onclick="setBoardSize(3)">3x3</button>
      <button onclick="setBoardSize(4)">4x4</button>
      <button onclick="setBoardSize(5)">5x5</button>
    </div>
    <div id="move-count">ç›®å‰æ‰€èŠ±æ­¥æ•¸: 0</div>
    <table id="board"></table>
    <div class="button-group">
      <button onclick="handleAction('z')">â†¶</button>
      <button onclick="handleAction('x')">â†º</button>
      <button onclick="handleAction('c')">â†·</button>
    </div>
    <div class="reset-btn">
      <button onclick="resetGame()">é‡æ–°é–‹å§‹</button>
      <button onclick="generateNew()">æ–°é¡Œç›®</button>
    </div>
    <div class="id-display">
      æ£‹ç›¤ ID: <span id="board-id"></span>
      <input type="text" id="input-id" maxlength="25" size="12" />
      <button onclick="loadFromInput()">è¼‰å…¥</button>
    </div>
  </div>
</div>

<div id="goal-page" class="hidden">
  <div class="container">
    <h2>éŠæˆ²ç›®æ¨™</h2>
    <p>åˆ©ç”¨ä¸‹æ–¹ä¸‰å€‹æŒ‰éˆ•å°‡æ•¸å­—è¯å®¹é“å›å¾©åˆ°ä¸‹åœ–çš„åŸç‹€</p>
    <table id="goal-board"></table>
    <button onclick="backToGame()">è¿”å›éŠæˆ²</button>
  </div>
</div>

<script>
let boardSize = 3;
let board = [];
let initBoard = [];
let moveCount = 0;
let currentId = "";
let target = [];

const scale3x3 = 1.25;
const scale4x4 = 1.1;
const scale5x5 = 1.0;

function setContainerScale() {
  const container = document.getElementById("container");
  if (boardSize === 3) container.style.transform = `scale(${scale3x3})`;
  if (boardSize === 4) container.style.transform = `scale(${scale4x4})`;
  if (boardSize === 5) container.style.transform = `scale(${scale5x5})`;
}

function toggleBoardSizeMenu() {
  document.getElementById("size-menu").classList.toggle("hidden");
}

function setBoardSize(n) {
  boardSize = n;
  document.getElementById("size-menu").classList.add("hidden");
  generateNew();
}

function generateNew() {
  const id = generateEvenPermutationID();
  setBoardFromId(id);
  moveCount = 0;
  drawBoard();
  setTarget();
  setContainerScale();
}

function setTarget() {
  target = [];
  let cnt = 1;
  for (let i = 0; i < boardSize; i++) {
    target.push([]);
    for (let j = 0; j < boardSize; j++) {
      if (i === boardSize - 1 && j === boardSize - 1) target[i].push(0);
      else target[i].push(cnt++);
    }
  }
}

function drawBoard() {
  const table = document.getElementById("board");
  table.innerHTML = "";
  for (let i = 0; i < boardSize; i++) {
    const row = table.insertRow();
    for (let j = 0; j < boardSize; j++) {
      const val = board[i][j];
      const cell = row.insertCell();
      if (val === 0) {
        cell.className = "empty";
        cell.innerText = "";
      } else {
        cell.innerText = val; // æ°¸é é¡¯ç¤ºæ­£å¸¸æ•¸å­—
      }
    }
  }
  document.getElementById("move-count").innerText = `ç›®å‰æ‰€èŠ±æ­¥æ•¸: ${moveCount}`;
  document.getElementById("board-id").innerText = currentId;

  if (JSON.stringify(board) === JSON.stringify(target)) {
    setTimeout(() => alert("ğŸ‰ æ­å–œä½ æˆåŠŸè§£å‡ºæ•¸å­—è¯å®¹é“ï¼"), 100);
  }
}

function rotateOuter(clockwise = true) {
  let pos = [];
  if (boardSize === 3) {
    pos = [[0,0],[0,1],[0,2],[1,2],[2,1],[2,0],[1,0]];
  } else if (boardSize === 4) {
    pos = [[0,0],[0,1],[0,2],[0,3],[1,3],[2,3],[3,2],[2,2],[1,2],[1,1],[2,1],[3,1],[3,0],[2,0],[1,0]];
  } else if (boardSize === 5) {
    pos = [[0,0],[0,1],[0,2],[0,3],[0,4],[1,4],[1,3],[1,2],[1,1],[2,1],[3,1],[3,2],[2,2],[2,3],[2,4],[3,4],[4,3],[4,2],[4,1],[4,0],[3,0],[2,0],[1,0]];
  }
  let vals = pos.map(([i,j]) => board[i][j]);
  if (clockwise) vals.unshift(vals.pop());
  else vals.push(vals.shift());
  pos.forEach(([i,j], idx) => board[i][j] = vals[idx]);
  board[boardSize-1][boardSize-1] = 0;
}

function rotateCornerRight() {
  const n = boardSize;
  const pos = [[n-2,n-1],[n-2,n-2],[n-1,n-2]];
  let vals = pos.map(([i,j]) => board[i][j]);
  vals.unshift(vals.pop());
  pos.forEach(([i,j],idx)=>board[i][j]=vals[idx]);
  board[n-1][n-1] = 0;
}

function handleAction(action) {
  if (JSON.stringify(board) === JSON.stringify(target)) return;
  if (action === 'z') rotateOuter(false);
  if (action === 'c') rotateOuter(true);
  if (action === 'x') rotateCornerRight();
  moveCount++;
  drawBoard();
}

function resetGame() {
  board = JSON.parse(JSON.stringify(initBoard));
  moveCount = 0;
  drawBoard();
}

function isEvenPermutation(arr) {
  let inv = 0;
  for (let i=0;i<arr.length;i++) {
    for (let j=i+1;j<arr.length;j++) {
      if (arr[i]>arr[j]) inv++;
    }
  }
  return inv%2===0;
}

function generateEvenPermutationID() {
  let arr = [];
  for (let i=1;i<=boardSize*boardSize-1;i++) arr.push(i);
  do {
    for (let i=arr.length-1;i>0;i--) {
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  } while(!isEvenPermutation(arr));
  const id = arr.map(x=>x>9?String.fromCharCode(87+x):x).join("");
  currentId = id;
  return id;
}

function setBoardFromId(id) {
  initBoard = idToBoard(id);
  board = JSON.parse(JSON.stringify(initBoard));
  currentId = id;
}

function idToBoard(id) {
  let arr = id.split("").map(c => /\d/.test(c) ? +c : c.charCodeAt(0)-87);
  arr.push(0);
  let b = [];
  for (let i=0;i<boardSize;i++) b.push(arr.slice(i*boardSize,i*boardSize+boardSize));
  return b;
}

function loadFromInput() {
  const id = document.getElementById("input-id").value.trim();
  const arr = id.split("").map(c => /\d/.test(c) ? +c : c.charCodeAt(0)-87);

  let n = Math.sqrt(arr.length + 1);
  if (![3,4,5].includes(n)) {
    alert("ç„¡æ•ˆçš„ ID é•·åº¦");
    return;
  }

  if (!isEvenPermutation(arr)) {
    alert("ç„¡æ•ˆçš„ ID");
    return;
  }

  boardSize = n;

  setTarget();
  setContainerScale();
  setBoardFromId(id);
  moveCount = 0;
  drawBoard();
}

function showGoal() {
  document.getElementById("game-page").classList.add("hidden");
  document.getElementById("goal-page").classList.remove("hidden");
  const table = document.getElementById("goal-board");
  table.innerHTML = "";
  for (let i=0;i<boardSize;i++) {
    const row=table.insertRow();
    for (let j=0;j<boardSize;j++) {
      const val = target[i][j];
      const cell = row.insertCell();
      if (val===0) {
        cell.className="empty"; cell.innerText="";
      } else {
        cell.innerText = val;
      }
    }
  }
}

function backToGame() {
  document.getElementById("goal-page").classList.add("hidden");
  document.getElementById("game-page").classList.remove("hidden");
}

generateNew();
</script>

</body>
</html>
